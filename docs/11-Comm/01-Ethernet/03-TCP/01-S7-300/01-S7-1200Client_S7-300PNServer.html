<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312" />
<title>S7-1200_Client</title>
<link href="mnp.css" rel="stylesheet" type="text/css" />
</head>

<body>
<h3>S7-1200 CPU 与S7-300 PN/S7-400 PN TCP通信（S7-1200作为客户端）</h3>
<p>S7-1200 与 S7-300 PN 之间的以太网通信可以通过 TCP 协议来实现，使用的通信指令是在双方 CPU 调用   T-block (TSEND_C，TRCV_C，TCON，TDISCON，TSEND，TRCV) 指令来实现。通信方式为双边通信，因此 TSEND 和   TRCV 必须成对出现。</p>
<p>此外本文也可以作为S7-1200 与 S7-400 PN 之间的 TCP 通信文档。</p>
<h3>硬件和软件需求及所完成的通信任务</h3>
<p>所需条件：</p>
<p>① S7-1200(CPU1215C DC/DC/DC，固件版本V4.4)/S7-300(集成PN口，固件版本V3.2)<br />
  ② TIA STEP7 V16，STEP7 V5.6</p>
<p>所完成的通信任务：<br />
  <br />
  ① S7-1200 CPU将通讯数据区 DB3 块中的 10 个字节的数据发送到 S7-300 CPU的接收数据区 DB2 块中。
  <br />
② S7-300 CPU将通讯数据区 DB1 块中的 10 个字节的数据发送到 S7-1200 CPU的接收数据区 DB4 块中。</p>
<p>S7-1200与S7-300(集成PN口)之间 TCP 通讯，可以分3种情况来操作，具体如下：</p>
<ol>
  <li><a href="01-S7-1200Client_S7-300PNServer.html#a">第一种情况：S7-1200与S7-300(集成PN口)在一个项目中操作(TIA STEP7 V16)； </a></li>
  <li><a href="01-S7-1200Client_S7-300PNServer.html#b">第二种情况：S7-1200与S7-300(集成PN口)不在一个项目中的操作(两个TIA STEP7 V16项目);</a></li>
  <li><a href="01-S7-1200Client_S7-300PNServer.html#c">第三种情况：S7-1200与S7-300(集成PN口)不在一个项目中的操作(S7-1200在TIA STEP7 V16项目中，S7-300在STEP7 V5.6项目中)。</a></li>
</ol>
<h3><a name="a" id="a"></a>一. 第一种情况（S7-1200与S7-300在同一项目中操作）</h3>
<p>使用 STEP 7 V16 在同一个项目中，新建一个S7-1200站点，一个S7-300站点，然后做 TCP 通讯。</p>
<h3>1.1 S7-1200 侧和S7-300PN 侧通信的编程，连接参数及通信参数的配置</h3>
<p><strong>1.	使用 STEP7 V16 软件新建一个项目并完成硬件配置</strong></p>
<p>在 STEP7 V16的 “Portal 视图” 中选择 “创建新项目” 创建一个新项目。</p>
<p><strong>2.</strong><strong>添加硬件并命名PLC</strong><br />
  <br />
然后进入 “项目视图”，在“项目树” 下双击 “添加新设备”，在对话框中选择所使用的 S7-1200   CPU 添加到机架上，命名为 PLC_1，如图1所示。<br />
<br />
<img src="images/1-01.JPG" width="707" height="695" /></p>
<p>图1. 添加新设备 </p>
<p>为了编程方便，使用 CPU 属性中定义的时钟位，定义方法如下：<br />
  在 “项目树” &gt; “PLC_1” &gt; “设备组态” 中，选中 CPU ，然后在下面的属性窗口中，“属性” &gt; “系统和时钟存储器”   下，将时钟位定义在 MB0，如图2所示。<br />
时钟位我们主要使用 M0.3，它是以 2Hz   的速率在 0 和 1 之间切换的一个位，可以使用它去自动激活发送任务。 </p>
<p><img src="images/1-02.JPG" width="605" height="545" /></p>
<p>图2. 时钟位</p>
<p><strong>3. 为 PROFINET 通信口分配以太网地址</strong></p>
<p>在 &ldquo;设备视图&rdquo;中点击 CPU 上代表 PROFINET 通信口的绿色小方块，在下方会出现 PROFINET 接口的属性，在 &ldquo;以太网地址&rdquo; 下分配 IP 地址为 192.168.0.1 ，子网掩码为255.255.255.0，如图3所示。</p>
<p><img src="images/1-03.JPG" width="758" height="390" /></p>
<p>图3. 分配IP 地址</p>
<p><strong>4．使用 STEP7 V16   软件添加新设备</strong><strong>并命名 PLC_2</strong><strong> </strong></p>
<p>与PLC_1在同一个项目中，在&ldquo;项目树&rdquo; 下双击 &ldquo;添加新设备&rdquo;，在对话框中选择所使用的 S7-300 CPU 添加到机架上，命名为 PLC_2，如图4所示。</p>
<p><img src="images/1-04.jpg" width="709" height="696" /></p>
<p>图4. 添加新设备 </p>
<p>为了编程方便，使用 CPU 属性中定义的时钟位，定义方法如下：<br />
  在 &ldquo;项目树&rdquo; &gt; &ldquo;PLC_2&rdquo; &gt; &ldquo;设备组态&rdquo; 中，选中 CPU ，然后在下面的属性窗口中，&ldquo;属性&rdquo; &gt; &ldquo;时钟存储器&rdquo;   下时钟位定义在 MB0，如图5所示。<br />
  时钟位我们主要使用 M0.3，它是以 2Hz 的速率在 0 和 1 之间切换的一个位，可以使用它去自动激活发送任务。</p>
<p><img src="images/1-05.jpg" width="449" height="344" /></p>
<p>图5. 时钟存储位 </p>
<p><strong>5. 为 PROFINET 通信口分配以太网地址</strong><strong> </strong></p>
<p>在 &ldquo;设备视图&rdquo;中点击 CPU 上代表 PROFINET 通信口的绿色小方块，在下方会出现 PROFINET 接口的属性，在 &ldquo;以太网地址&rdquo; 下分配 IP 地址为 192.168.0.2 ，子网掩码为255.255.255.0，如图6所示。<br />
<img src="images/1-06.jpg" width="741" height="385" /></p>
<p>图6. 分配IP 地址</p>
<p><strong>6. 创建 CPU的逻辑网络连接</strong></p>
<p>在项目树 &ldquo;项目树&rdquo;&gt;&ldquo;设备和网络&rdquo; &gt;&ldquo;网络视图&rdquo; 视图下，创建两个设备的连接。用鼠标点中 S7-1200   上的PROFINET通信口的绿色小方框，然后拖拽出一条线，到另外一个 S7-300  上的PROFINET通信口上，松开鼠标，PN/IE_1的子网连接就建立起来了，如图7所示。
  <br />
</p>
<p><img src="images/1-07.jpg" width="456" height="196" /></p>
<p>图7. 网络视图</p>
<h3>1.2 在 S7-1200 中调用并配置&ldquo;TCON&rdquo;、&ldquo;TSEND&rdquo;、&ldquo;TRCV&rdquo; 通信指令</h3>
<h4><strong>1．在 S7-1200 的 OB1 中调用&ldquo;TCON&rdquo; 通信指令 </strong></h4>
<p>① 在S7-1200 CPU 中调用发送通信指令，进入 &ldquo;项目树&rdquo; &gt; &ldquo; PLC_1&rdquo; &gt; &ldquo;程序块&rdquo; &gt; &ldquo;OB1&rdquo; 主程序中，从右侧窗口 &ldquo;指令&rdquo; &gt; &ldquo;通信&rdquo; &gt; &ldquo;开放式用户通信&rdquo;下调用 &ldquo;TCON&rdquo; 指令，创建连接，如图8所示。<br />
  <img src="images/1-08.jpg" width="564" height="293" /><br />
图8. 调用&ldquo;TCON&rdquo;通信指令</p>
<p><strong>注意：</strong>
</h4>
S7-1200必须等S7-300先准备好（触发S7-300的TCON）后，才可以触发TCON。</p>
<p> ② 定义 S7-1200 的 “TCON”连接参数</p>
<p>S7-1200 的 “TCON”指令的连接参数需要在指令下方的属性窗口“属性”&gt; “组态”&gt;“连接参数”中设置，如图9所示。<br />
<img src="images/1-09.jpg" width="947" height="553" /></p>
<p>图9. 定义 TCON 连接参数 <br />
  <br />
<strong>连接参数说明：</strong></p>
<table border="0" width="775">
  <tbody>
    <tr>
      <td width="122">端点</td>
      <td width="743"><div align="left">：可以通过点击选择按钮选择伙伴CPU为“PLC_2，CPU315-2PN/DP” ； </div></td>
    </tr>
    <tr>
      <td>连接类型</td>
      <td><div align="left">：选择通信协议为 TCP；</div></td>
    </tr>
    <tr>
      <td>连接 ID　</td>
      <td><div align="left">：连接的地址 ID 号，这个 ID 号在后面的编程里会用到；</div></td>
    </tr>
    <tr>
      <td>连接数据</td>
      <td><div align="left">：点击新建自动生成该数据块，如PLC_1_Connection_DB和PLC_2_Connection_DB；</div></td>
    </tr>
    <tr>
      <td>主动建立连接</td>
      <td><div align="left">：选择本地 S7-1200 作为主动连接；</div></td>
    </tr>
    <tr>
      <td>地址详细信息</td>
      <td><div align="left">：定义通信伙伴方的端口号为：2000。　　</div></td>
    </tr>
  </tbody>
</table>
<h4><strong>2．定义 S7-1200 的&ldquo;TSEND&rdquo;发送通信块接口参数</strong></h4>
<p>①　调用 &ldquo;TSEND&rdquo; 在OB1内调用，发送10个字节数据到 S7-300PN 中 <br />
进入 &ldquo;项目树&rdquo; &gt; &ldquo; PLC_1&rdquo; &gt; &ldquo;程序块&rdquo; &gt; &ldquo;OB1&rdquo; 主程序中，从右侧窗口 &ldquo;指令&rdquo; &gt; &ldquo;通信&rdquo; &gt; &ldquo;开放式用户通信&rdquo;下调用 &ldquo;TSEND&rdquo; 指令，如图10所示。</p>
<p><img src="images/1-10.jpg" width="728" height="559" /></p>
<p>图10. 调用 TSEND </p>
<p>②　创建并定义S7-1200的发送数据区 DB 块。<br />
  <br />
通过&ldquo;项目树&rdquo;&gt;&ldquo;PLC_1&rdquo;&gt;&ldquo;程序块&rdquo;&gt;&ldquo;添加新块&rdquo;，选择&ldquo;数据块&rdquo; 创建 DB 块，在DB块的&ldquo;属性-&gt;常规-&gt;属性&rdquo;中，取消勾选&ldquo;优化的块访问&rdquo;，点击&ldquo;确定&rdquo;键，定义发送数据区为 10个字节的数组，如图11及图12所示。
</h4>
</p>
<p><img src="images/1-11.jpg" width="1131" height="599" /><br />
  <br />
  图11. 创建发送数据区 DB 块<br />
  <br />
注意：对于双边编程通信的 CPU ，如果通信数据区使用 DB 块，既可以将 DB 块定义成符号寻址，也可以定义成绝对寻址。使用指针寻址方式，必须创建绝对寻址的 DB 块。</p>
<p><img src="images/1-12.JPG" width="520" height="79" /></p>
<p>图12. 定义发送数据区为字节类型的数组 </p>
<p>③　定义S7-1200 的&ldquo;TSEND&rdquo;发送通信块接口参数，如图13所示。</p>
<p><img src="images/1-13.jpg" width="559" height="292" /><br />
  <br />
  图13. 定义 TSEND 接口参数<br />
  <br />
  <strong>参数说明：</strong><br />
<strong>输入接口参数：</strong></p>
<table width="480" border="0
">
  <tr>
    <td width="94"><div align="left">REQ　　</div></td>
    <td width="376"><div align="left">：在上升沿启动发送作业</div></td>
  </tr>
  <tr>
    <td><div align="left">ID　</div></td>
    <td><div align="left">： 引用由&ldquo;TCON&rdquo;建立的连接</div></td>
  </tr>
  <tr>
    <td><div align="left">LEN</div></td>
    <td><div align="left">：要通过作业发送的最大字节数</div></td>
  </tr>
  <tr>
    <td><div align="left">DATA　</div></td>
    <td><div align="left">：发送数据区的数据，使用指针寻址时，DB块要选用绝对寻址</div></td>
  </tr>
</table>
<p><strong>输出接口参数：</strong></p>
<table width="468" border="0">
  <tr>
    <td width="125"><div align="left">DONE</div></td>
    <td width="333" ><div align="left">：任务执行完成并且没有错误，该位置 1</div></td>
  </tr>
  <tr>
    <td><div align="left">BUSY　</div></td>
    <td><div align="left">：该位为 1，代表任务未完成，不能激活新任务</div></td>
  </tr>
  <tr>
    <td><div align="left">ERROR　　　</div></td>
    <td><div align="left">：通信过程中有错误发生，该位置 1</div></td>
  </tr>
  <tr>
    <td><div align="left">STATUS</div></td>
    <td><div align="left">：有错误发生时，会显示错位信息号</div></td>
  </tr>
</table>
<h4><strong>3．在  S7-1200 的OB1中调用接收指令TRCV 并配置基本参数</strong></h4>
<p>为了实现 S7-1200 接收来自  S7-300PN 的数据，则在 S7-1200 中调用接收指令TRCV 并配置基本参数。 </p>
<p>①　创建并定义S7-1200的接收数据区 DB 块。<br />
  <br />
通过&ldquo;项目树&rdquo;&gt;&ldquo;PLC_1&rdquo;&gt;&ldquo;程序块&rdquo;&gt;&ldquo;添加新块&rdquo;，选择&ldquo;数据块&rdquo; 创建 DB 块，在DB块的&ldquo;属性-&gt;常规-&gt;属性&rdquo;中，取消勾选&ldquo;优化的块访问&rdquo;，点击&ldquo;确定&rdquo;键，定义接收数据区为 10个字节的数组，如图14及图15所示。 </p>
<p><img src="images/1-14.jpg" width="1131" height="599" /><br />
  <br />
  图14. 创建接收数据区 DB 块<br />
  <br />
注意：对于双边编程通信的 CPU ，如果通信数据区使用 DB 块，既可以将 DB 块定义成符号寻址，也可以定义成绝对寻址。使用指针寻址方式，必须创建绝对寻址的 DB 块。</p>
<p><img src="images/1-15.JPG" width="518" height="79" /></p>
<p>图15. 定义接收数据区为字节类型的数组</p>
<p>②　调用 &ldquo;TRCV&rdquo; 在OB1内调用 <br />
  进入 &ldquo;项目树&rdquo; &gt; &ldquo; PLC_1&rdquo; &gt; &ldquo;程序块&rdquo; &gt; &ldquo;OB1&rdquo; 主程序中，从右侧窗口 &ldquo;指令&rdquo; &gt; &ldquo;通信&rdquo; &gt; &ldquo;开放式用户通信&rdquo;下调用 &ldquo;TRCV&rdquo; 指令，配置接口参数，如图16所示。<br />
  <br />
  <img src="images/1-16.JPG" width="563" height="330" /><br />
  图16. 调用 TRCV 指令并配置接口参数</p>
<p><strong>参数说明：</strong><br />
<strong>输入接口参数：</strong></p>
<table width="498" border="0">
  <tr>
    <td width="100"><div align="left">EN_R </div></td>
    <td width="388"><div align="left">：启用接收功能</div></td>
  </tr>
  <tr>
    <td><div align="left">ID</div></td>
    <td><div align="left">： 指向使用&ldquo;TCON&rdquo;建立的连接的引用</div></td>
  </tr>
  <tr>
    <td><div align="left">LEN</div></td>
    <td><div align="left">：接收数据长度</div></td>
  </tr>
  <tr>
    <td><div align="left">ADHOC</div></td>
    <td><div align="left">： TCP协议选项是否使用Ad-hoc模式</div></td>
  </tr>
  <tr>
    <td><div align="left">DATA </div></td>
    <td><div align="left">： 接收数据区的地址</div></td>
  </tr>
</table>
<p><strong>输出接口参数：</strong></p>
<table width="460" border="0">
  <tr>
    <td width="99"><div align="left">NDR </div></td>
    <td width="351"><div align="left">：该位为 1，接收任务成功完成</div></td>
  </tr>
  <tr>
    <td><div align="left">BUSY</div></td>
    <td><div align="left">：该位为 1，代表任务未完成，不能激活新任务</div></td>
  </tr>
  <tr>
    <td><div align="left">ERROR </div></td>
    <td><div align="left">：通信过程中有错误发生，该位置 1</div></td>
  </tr>
  <tr>
    <td><div align="left">STATUS</div></td>
    <td><div align="left"> ：有错误发生时，会显示错误信息号</div></td>
  </tr>
  <tr>
    <td><div align="left">RCVD_LEN　　</div></td>
    <td><div align="left">：实际接收数据的字节数</div></td>
  </tr>
</table>
<p><strong>注意：ADHOC设置为 TRUE ，LEN设置为0时，可以接收变长数据。 </strong></p>
<h3>1.3在 S7-300 中调用并配置&ldquo;TCON&rdquo;、&ldquo;TSEND&rdquo;、&ldquo;TRCV&rdquo; 通信指令</h3>
<h4><strong>1．在 S7-300 的 OB1 中调用&ldquo;TCON&rdquo; 通信指令 </strong></h4>
<p>① 在 S7-300 CPU 中调用发送通信指令，进入 &ldquo;项目树&rdquo; &gt; &ldquo;PLC_2&rdquo; &gt; &ldquo;程序块&rdquo; &gt;   &ldquo;OB1&rdquo; 主程序中，从右侧窗口 &ldquo;指令&rdquo; &gt; &ldquo;通讯&rdquo; &gt; &ldquo;开放式用户通信&rdquo;下调用 &ldquo;TCON&rdquo; 指令，创建连接，如图17所示。</p>
<p><img src="images/1-17.jpg" width="565" height="294" /></p>
<p>图17. 调用 TCON 通信指令</p>
<p>② 定义 S7-300 的 &ldquo;TCON&rdquo;连接参数</p>
<p>S7-300 的 &ldquo;TCON&rdquo;指令的连接参数需要在指令下方的属性窗口&ldquo;属性&rdquo;&gt; &ldquo;组态&rdquo;&gt;&ldquo;连接参数中&rdquo;中设置，如图18所示。</p>
<p><img src="images/1-18.jpg" width="1112" height="557" /></p>
<p>图18. 定义 TCON 连接参数 </p>
<p><strong>连接参数说明：</strong></p>
<table border="0" width="852">
  <tbody>
    <tr>
      <td width="124">端点</td>
      <td width="767"><div align="left">：可以通过点击选择按钮选择&ldquo;PLC_1&rdquo;； </div></td>
    </tr>
    <tr>
      <td>连接类型</td>
      <td><div align="left">：选择通信协议为 TCP；</div></td>
    </tr>
    <tr>
      <td>连接 ID　</td>
      <td><div align="left">：连接的地址 ID 号，这个 ID 号在后面的编程里会用到；</div></td>
    </tr>
    <tr>
      <td>连接数据</td>
      <td><div align="left">：<strong> 选择之前已建立的数据块（如图9所示）</strong>PLC_2_Connection_DB和PLC_1_Connection_DB；</div></td>
    </tr>
    <tr>
      <td>主动建立连接</td>
      <td><div align="left">：选择对方 S7-1200 作为主动连接；</div></td>
    </tr>
    <tr>
      <td>地址详细信息</td>
      <td><div align="left">：定义本方的端口号为：2000。　　</div></td>
    </tr>
  </tbody>
</table>
<h4><strong>2．定义 S7-300 的&ldquo;TSEND&rdquo;发送通信块接口参数</strong></h4>
<p>①创建并定义 S7-300 的发送数据区 DB1 块</p>
<p>通过&ldquo;项目树&rdquo;&gt;&ldquo;PLC_2&rdquo;&gt;&ldquo;程序块&rdquo;&gt;&ldquo;添加新块&rdquo;，选择&ldquo;数据块&rdquo; 创建 DB1 块，点击&ldquo;确定&rdquo;键，定义发送数据区为 10个字节的数组，如图19所示，结果如图20所示。</p>
<p><img src="images/1-19.jpg" width="691" height="599" /></p>
<p>图19. 创建发送数据区 DB 块</p>
<p><img src="images/1-20.JPG" width="526" height="80" /></p>
<p>图20. 定义发送数据区为字节类型的数组 </p>
<p>②调用 &ldquo;TSEND&rdquo; 在OB1内调用 发送 10 个字节数据到 S7-1200 中 <br />
  进入 &ldquo;项目树&rdquo; &gt; &ldquo;PLC_2&rdquo; &gt;   &ldquo;程序块&rdquo; &gt; &ldquo;OB1 &rdquo; 主程序中，从右侧窗口 &ldquo;指令&rdquo; &gt; &ldquo;通讯&rdquo; &gt;   &ldquo;开放式用户通信&rdquo;下调用 &ldquo;TSEND&rdquo; 指令，配置接口参数，如图21所示。</p>
<p><img src="images/1-21.jpg" width="564" height="289" /></p>
<p>图21. 调用 TSEND 指令并配置接口参数</p>
<p><strong>参数说明：</strong><br />
  <strong>输入接口参数：</strong></p>
<table border="0" width="484">
  <tbody>
    <tr>
      <td width="96"><div align="left">REQ　　</div></td>
      <td width="357"><div align="left">：在上升沿启动发送作业</div></td>
    </tr>
    <tr>
      <td><div align="left">ID </div></td>
      <td><div align="left">：引用由&ldquo;TCON&rdquo;建立的连接</div></td>
    </tr>
    <tr>
      <td><div align="left">LEN</div></td>
      <td><div align="left">：要通过作业发送的最大字节数</div></td>
    </tr>
    <tr>
      <td><div align="left">DATA　</div></td>
      <td><div align="left">：发送数据区的数据，使用指针寻址时，DB块要选用绝对寻址</div></td>
    </tr>
  </tbody>
</table>
<p><strong>输出接口参数：</strong></p>
<table border="0" width="484">
  <tbody>
    <tr>
      <td width="142"><div align="left">DONE</div></td>
      <td width="332" ><div align="left">：任务执行完成并且没有错误，该位置 1</div></td>
    </tr>
    <tr>
      <td><div align="left">BUSY　</div></td>
      <td><div align="left">：该位为 1，代表任务未完成，不能激活新任务</div></td>
    </tr>
    <tr>
      <td><div align="left">ERROR　　　</div></td>
      <td><div align="left">：通信过程中有错误发生，该位置 1</div></td>
    </tr>
    <tr>
      <td><div align="left">STATUS</div></td>
      <td><div align="left">：有错误发生时，会显示错位信息号</div></td>
    </tr>
  </tbody>
</table>
<h4><strong>3．在 S7-300 的OB1中调用接收指令TRCV并配置参数</strong></h4>
<p>①创建并定义 S7-300 的接收数据区 DB2 块。<br />
  <br />
通过&ldquo;项目树&rdquo;&gt;&ldquo;PLC_2&rdquo;&gt;&ldquo;程序块&rdquo;&gt;&ldquo;添加新块&rdquo;，选择&ldquo;数据块&rdquo; 创建 DB2 块，点击&ldquo;确定&rdquo;键，定义接收数据区为 10 个字节的数组，如图22所示，结果如图23所示。</p>
<p><img src="images/1-22.jpg" width="691" height="598" /></p>
<p>图22. 创建接收数据区 DB2 块</p>
<p><img src="images/1-23.JPG" width="512" height="80" /></p>
<p>图23. 定义接收数据区为字节类型的数组</p>
<p>② 将 &ldquo;TRCV&rdquo; 在OB1内调用 <br />
  进入 &ldquo;项目树&rdquo; &gt; &ldquo;PLC_2&rdquo; &gt;   &ldquo;程序块&rdquo; &gt; &ldquo;OB1 &rdquo; 主程序中，从右侧窗口 &ldquo;指令&rdquo; &gt; &ldquo;通讯&rdquo; &gt;   &ldquo;开放式用户通信&rdquo;下调用 &ldquo;TRCV&rdquo; 指令，配置接口参数，如图24所示。</p>
<p><img src="images/1-24.JPG" width="709" height="421" /></p>
<p>图24. 调用 TRCV 指令并配置接口参数</p>
<p><strong>参数说明：</strong><br />
  <strong>输入接口参数：</strong></p>
<table border="0" width="530">
  <tbody>
    <tr>
      <td width="100"><div align="left">EN_R </div></td>
      <td width="388"><div align="left">：启用接收功能</div></td>
    </tr>
    <tr>
      <td><div align="left">ID</div></td>
      <td><div align="left">：指向使用&ldquo;TCON&rdquo;建立的连接的引用</div></td>
    </tr>
    <tr>
      <td><div align="left">LEN</div></td>
      <td><div align="left">：接收数据长度</div></td>
    </tr>
    <tr>
      <td><div align="left">DATA </div></td>
      <td><div align="left">：接收数据区的地址</div></td>
    </tr>
  </tbody>
</table>
<p><strong>输出接口参数：</strong></p>
<table border="0" width="460">
  <tbody>
    <tr>
      <td width="99"><div align="left">NDR </div></td>
      <td width="351"><div align="left">：该位为 1，接收任务成功完成</div></td>
    </tr>
    <tr>
      <td><div align="left">BUSY</div></td>
      <td><div align="left">：该位为 1，代表任务未完成，不能激活新任务</div></td>
    </tr>
    <tr>
      <td><div align="left">ERROR </div></td>
      <td><div align="left">：通信过程中有错误发生，该位置 1</div></td>
    </tr>
    <tr>
      <td><div align="left">STATUS</div></td>
      <td><div align="left"> ：有错误发生时，会显示错误信息号</div></td>
    </tr>
    <tr>
      <td><div align="left">RCVD_LEN　　</div></td>
      <td><div align="left">：实际接收数据的字节数</div></td>
    </tr>
  </tbody>
</table>
<p>配置完连接并编译存盘。<br />
</p>
<h3>1.4 下载硬件组态及程序并监控通信结果</h3>
<p>下载两个 CPU 中的所有硬件组态及程序，实现两个 CPU 之间数据交换，监控结果如图25所示。</p>
<p><img src="images/1-25.jpg" width="805" height="496" /></p>
<p>图25. 监控结果</p>
<h3><a name="b" id="b"></a>二. 第二种情况（S7-1200与S7-300不在同一个TIA项目中操作）</h3>
<p>使用 STEP 7 V16 在一个项目中，新建一个S7-300站点，在另一个项目中，新建一个S7-1200站点，然后做 TCP 通讯。 </p>
<h3>2.1 S7-300PN 侧通信的编程，连接参数及通信参数的配置</h3>
<p><strong>1．使用 STEP7 V16   软件新建项目，添加新设备</strong><strong>并命名 PLC_2</strong><strong> </strong></p>
<p>打开STEP7 V16，在 STEP7 V16的 &ldquo;Portal 视图&rdquo; 中选择 &ldquo;创建新项目&rdquo; 创建一个新项目。然后进入 &ldquo;项目视图&rdquo;，在&ldquo;项目树&rdquo; 下双击 &ldquo;添加新设备&rdquo;，在对话框中选择所使用的 S7-300 CPU 添加到机架上，命名为 PLC_2，如图26所示。</p>
<p><img src="images/1-04.jpg" width="709" height="696" /></p>
<p>图26. 添加新设备 </p>
<p>为了编程方便，使用 CPU 属性中定义的时钟位，定义方法如下：<br />
  在 &ldquo;项目树&rdquo; &gt; &ldquo;PLC_2&rdquo; &gt; &ldquo;设备组态&rdquo; 中，选中 CPU ，然后在下面的属性窗口中，&ldquo;属性&rdquo; &gt; &ldquo;时钟存储器&rdquo;   下时钟位定义在 MB0，如图27所示。<br />
  时钟位我们主要使用 M0.3，它是以 2Hz 的速率在 0 和 1 之间切换的一个位，可以使用它去自动激活发送任务。</p>
<p><img src="images/1-05.jpg" width="449" height="344" /></p>
<p>图27. 时钟存储位 </p>
<p><strong>2. 为 PROFINET 通信口分配以太网地址</strong><strong> </strong></p>
<p>在 &ldquo;设备视图&rdquo;中点击 CPU 上代表PROFINET 通信口的绿色小方块，在下方会出现PROFINET 接口的属性，在 &ldquo;以太网地址&rdquo; 下分配IP 地址为 192.168.0.2 ，子网掩码为255.255.255.0，图28所示。<br />
  <img src="images/1-06.jpg" width="741" height="385" /></p>
<p>图28. 分配IP 地址</p>
<h3>2.2在 S7-300 中调用并配置&ldquo;TCON&rdquo;、&ldquo;TSEND&rdquo;、&ldquo;TRCV&rdquo; 通信指令</h3>
<h4><strong>1．在 S7-300 的 OB1 中调用&ldquo;TCON&rdquo; 通信指令 </strong></h4>
<p>① 在 S7-300 CPU 中调用发送通信指令，进入 &ldquo;项目树&rdquo; &gt; &ldquo;PLC_2&rdquo; &gt; &ldquo;程序块&rdquo; &gt;   &ldquo;OB1&rdquo; 主程序中，从右侧窗口 &ldquo;指令&rdquo; &gt; &ldquo;通讯&rdquo; &gt; &ldquo;开放式用户通信&rdquo;下调用 &ldquo;TCON&rdquo; 指令，创建连接，如图29所示。</p>
<p><img src="images/1-17.jpg" width="565" height="294" /></p>
<p>图29. 调用 TCON 通信指令</p>
<p>② 定义 S7-300 的 &ldquo;TCON&rdquo;连接参数</p>
<p>S7-300 的 &ldquo;TCON&rdquo;指令的连接参数需要在指令下方的属性窗口&ldquo;属性&rdquo;&gt; &ldquo;组态&rdquo;&gt;&ldquo;连接参数中&rdquo;中设置，如图30所示。</p>
<p><img src="images/1-26.jpg" width="956" height="556" /></p>
<p>图30. 定义 TCON 连接参数 </p>
<p>地址处输入伙伴IP：192.168.0.1。</p>
<p><strong>连接参数说明：</strong></p>
<table border="0" width="684">
  <tbody>
    <tr>
      <td width="117">端点</td>
      <td width="595"><div align="left">：可以通过点击选择按钮选择&ldquo;未指定&rdquo;； </div></td>
    </tr>
    <tr>
      <td>连接类型</td>
      <td><div align="left">：选择通信协议为 TCP；</div></td>
    </tr>
    <tr>
      <td>连接 ID　</td>
      <td><div align="left">：连接的地址 ID 号，这个 ID 号在后面的编程里会用到；</div></td>
    </tr>
    <tr>
      <td>连接数据</td>
      <td><div align="left">：点击新建自动生成该数据块；</div></td>
    </tr>
    <tr>
      <td>主动建立连接</td>
      <td><div align="left">：选择对方 S7-1200 作为主动连接；</div></td>
    </tr>
    <tr>
      <td>地址详细信息</td>
      <td><div align="left">：定义本方的端口号为：2000。　　</div></td>
    </tr>
  </tbody>
</table>
<h4><strong>2．定义 S7-300 的&ldquo;TSEND&rdquo;发送通信块接口参数</strong></h4>
<p>①创建并定义 S7-300 的发送数据区 DB1 块</p>
<p>通过&ldquo;项目树&rdquo;&gt;&ldquo;PLC_2&rdquo;&gt;&ldquo;程序块&rdquo;&gt;&ldquo;添加新块&rdquo;，选择&ldquo;数据块&rdquo; 创建 DB1 块，点击&ldquo;确定&rdquo;键，定义发送数据区为 10个字节的数组，如图31所示，结果如图32所示。</p>
<p><img src="images/1-19.jpg" width="691" height="599" /></p>
<p>图31. 创建发送数据区 DB 块</p>
<p><img src="images/1-20.JPG" width="526" height="80" /></p>
<p>图32. 定义发送数据区为字节类型的数组</p>
<p>②调用 &ldquo;TSEND&rdquo; 在OB1内调用 发送 10 个字节数据到 S7-1200 中 <br />
  进入 &ldquo;项目树&rdquo; &gt; &ldquo;PLC_2&rdquo; &gt;   &ldquo;程序块&rdquo; &gt; &ldquo;OB1 &rdquo; 主程序中，从右侧窗口 &ldquo;指令&rdquo; &gt; &ldquo;通讯&rdquo; &gt;   &ldquo;开放式用户通信&rdquo;下调用 &ldquo;TSEND&rdquo; 指令，配置接口参数，如图33所示。</p>
<p><img src="images/1-21.jpg" width="564" height="289" /></p>
<p>图33. 调用 TSEND 指令并配置接口参数</p>
<p><strong>参数说明：</strong><br />
  <strong>输入接口参数：</strong></p>
<table border="0" width="484">
  <tbody>
    <tr>
      <td width="72"><div align="left">REQ　　</div></td>
      <td width="402"><div align="left">：在上升沿启动发送作业</div></td>
    </tr>
    <tr>
      <td><div align="left">ID </div></td>
      <td><div align="left">：引用由&ldquo;TCON&rdquo;建立的连接</div></td>
    </tr>
    <tr>
      <td><div align="left">LEN</div></td>
      <td><div align="left">：要通过作业发送的最大字节数</div></td>
    </tr>
    <tr>
      <td><div align="left">DATA　</div></td>
      <td><div align="left">：发送数据区的数据，使用指针寻址时，DB块要选用绝对寻址</div></td>
    </tr>
  </tbody>
</table>
<p><strong>输出接口参数：</strong></p>
<table border="0" width="464">
  <tbody>
    <tr>
      <td width="91"><div align="left">DONE</div></td>
      <td width="363" ><div align="left">：任务执行完成并且没有错误，该位置 1</div></td>
    </tr>
    <tr>
      <td><div align="left">BUSY　</div></td>
      <td><div align="left">：该位为 1，代表任务未完成，不能激活新任务</div></td>
    </tr>
    <tr>
      <td><div align="left">ERROR　　　</div></td>
      <td><div align="left">：通信过程中有错误发生，该位置 1</div></td>
    </tr>
    <tr>
      <td><div align="left">STATUS</div></td>
      <td><div align="left">：有错误发生时，会显示错位信息号</div></td>
    </tr>
  </tbody>
</table>
<h4><strong>3．定义 S7-300 的OB1中调用接收指令TRCV 并配置基本参数</strong></h4>
<p>①创建并定义 S7-300 的接收数据区 DB2 块。<br />
  <br />
  通过&ldquo;项目树&rdquo;&gt;&ldquo;PLC_2&rdquo;&gt;&ldquo;程序块&rdquo;&gt;&ldquo;添加新块&rdquo;，选择&ldquo;数据块&rdquo; 创建 DB2 块，点击&ldquo;确定&rdquo;键，定义接收数据区为 10 个字节的数组，如图34所示，结果如图35所示。</p>
<p><img src="images/1-22.jpg" width="691" height="598" /></p>
<p>图34. 创建接收数据区 DB2 块</p>
<p><img src="images/1-23.JPG" width="512" height="80" /></p>
<p>图35. 定义接收数据区为字节类型的数组</p>
<p>② 将 &ldquo;TRCV&rdquo; 在OB1内调用 <br />
  进入 &ldquo;项目树&rdquo; &gt; &ldquo;PLC_2&rdquo; &gt;   &ldquo;程序块&rdquo; &gt; &ldquo;OB1 &rdquo; 主程序中，从右侧窗口 &ldquo;指令&rdquo; &gt; &ldquo;通讯&rdquo; &gt;   &ldquo;开放式用户通信&rdquo;下调用 &ldquo;TRCV&rdquo; 指令，配置接口参数，如图36所示。</p>
<p><img src="images/1-24.JPG" width="709" height="421" /></p>
<p>图36. 调用 TRCV 指令并配置接口参数</p>
<p><strong>参数说明：</strong><br />
  <strong>输入接口参数：</strong></p>
<table border="0" width="530">
  <tbody>
    <tr>
      <td width="100"><div align="left">EN_R </div></td>
      <td width="388"><div align="left">：启用接收功能</div></td>
    </tr>
    <tr>
      <td><div align="left">ID</div></td>
      <td><div align="left">：指向使用&ldquo;TCON&rdquo;建立的连接的引用</div></td>
    </tr>
    <tr>
      <td><div align="left">LEN</div></td>
      <td><div align="left">：接收数据长度</div></td>
    </tr>
    <tr>
      <td><div align="left">DATA </div></td>
      <td><div align="left">：接收数据区的地址</div></td>
    </tr>
  </tbody>
</table>
<p><strong>输出接口参数：</strong></p>
<table border="0" width="460">
  <tbody>
    <tr>
      <td width="99"><div align="left">NDR </div></td>
      <td width="351"><div align="left">：该位为 1，接收任务成功完成</div></td>
    </tr>
    <tr>
      <td><div align="left">BUSY</div></td>
      <td><div align="left">：该位为 1，代表任务未完成，不能激活新任务</div></td>
    </tr>
    <tr>
      <td><div align="left">ERROR </div></td>
      <td><div align="left">：通信过程中有错误发生，该位置 1</div></td>
    </tr>
    <tr>
      <td><div align="left">STATUS</div></td>
      <td><div align="left"> ：有错误发生时，会显示错误信息号</div></td>
    </tr>
    <tr>
      <td><div align="left">RCVD_LEN　　</div></td>
      <td><div align="left">：实际接收数据的字节数</div></td>
    </tr>
  </tbody>
</table>
<p>配置完连接并编译存盘。</p>
<h3>2.3 S7-1200 侧通信的编程，连接参数及通信参数的配置</h3>
<p><strong>1.	使用 STEP7 V16 软件新建一个项目并完成硬件配置</strong></p>
<p>在 STEP7 V16的 &ldquo;Portal 视图&rdquo; 中选择 &ldquo;创建新项目&rdquo; 创建一个新项目。</p>
<p><strong>2.</strong><strong>添加硬件并命名PLC</strong><br />
  <br />
  然后进入 &ldquo;项目视图&rdquo;，在&ldquo;项目树&rdquo; 下双击 &ldquo;添加新设备&rdquo;，在对话框中选择所使用的 S7-1200   CPU 添加到机架上，命名为 PLC_1，如图37所示。<br />
  <br />
  <img src="images/1-01.JPG" width="707" height="695" /></p>
<p>图37. 添加新设备 </p>
<p>为了编程方便，使用 CPU 属性中定义的时钟位，定义方法如下：<br />
  在 &ldquo;项目树&rdquo; &gt; &ldquo;PLC_1&rdquo; &gt; &ldquo;设备组态&rdquo; 中，选中 CPU ，然后在下面的属性窗口中，&ldquo;属性&rdquo; &gt; &ldquo;系统和时钟存储器&rdquo;   下，将时钟位定义在 MB0，如图38所示。<br />
  时钟位我们主要使用 M0.3，它是以 2Hz   的速率在 0 和 1 之间切换的一个位，可以使用它去自动激活发送任务。 </p>
<p><img src="images/1-02.JPG" width="605" height="545" /></p>
<p>图38. 时钟位</p>
<p><strong>3. 为 PROFINET 通信口分配以太网地址</strong></p>
<p>在 &ldquo;设备视图&rdquo;中点击 CPU 上代表PROFINET 通信口的绿色小方块，在下方会出现PROFINET 接口的属性，在 &ldquo;以太网地址&rdquo; 下分配IP 地址为 192.168.0.1 ，子网掩码为255.255.255.0，如图39所示。</p>
<p><img src="images/1-06.jpg" width="692" height="376" /></p>
<p>图39. 分配IP 地址</p>
<h3>2.4在 S7-1200 中调用并配置&ldquo;TCON&rdquo;、&ldquo;TSEND&rdquo;、&ldquo;TRCV&rdquo; 通信指令</h3>
<h4><strong>1．在 S7-1200 的 OB1 中调用&ldquo;TCON&rdquo; 通信指令 </strong></h4>
<p>① 在S7-1200 CPU 中调用发送通信指令，进入 &ldquo;项目树&rdquo; &gt; &ldquo; PLC_1&rdquo; &gt; &ldquo;程序块&rdquo; &gt; &ldquo;OB1&rdquo; 主程序中，从右侧窗口 &ldquo;指令&rdquo; &gt; &ldquo;通信&rdquo; &gt; &ldquo;开放式用户通信&rdquo;下调用 &ldquo;TCON&rdquo; 指令，创建连接，如图40所示。<br />
  <img src="images/1-08.jpg" width="564" height="293" /><br />
  图40. 调用&ldquo;TCON&rdquo;通信指令
  </h4>
</p>
<p><strong>注意：</strong>
  </h4>
S7-1200必须等S7-300先准备好（触发S7-300的TCON）后，才可以触发TCON。 </p>
<p> ② 定义 S7-1200 的 &ldquo;TCON&rdquo;连接参数</p>
<p>S7-1200 的 &ldquo;TCON&rdquo;指令的连接参数需要在指令下方的属性窗口&ldquo;属性&rdquo;&gt; &ldquo;组态&rdquo;&gt;&ldquo;连接参数&rdquo;中设置，如图41所示。<br />
  <img src="images/1-27.jpg" width="967" height="556" /></p>
<p>图41. 定义 TCON 连接参数 <br />
  <br />
<strong>连接参数说明：</strong></p>
<table border="0" width="684">
  <tbody>
    <tr>
      <td width="117">端点</td>
      <td width="595"><div align="left">：可以通过点击选择按钮选择伙伴CPU为&ldquo;未指定&rdquo; ； </div></td>
    </tr>
    <tr>
      <td>连接类型</td>
      <td><div align="left">：选择通信协议为 TCP；</div></td>
    </tr>
    <tr>
      <td>连接 ID　</td>
      <td><div align="left">：连接的地址 ID 号，这个 ID 号在后面的编程里会用到；</div></td>
    </tr>
    <tr>
      <td>连接数据</td>
      <td><div align="left">：点击新建自动生成该数据块，如PLC_1_Connection_DB；</div></td>
    </tr>
    <tr>
      <td>主动建立连接</td>
      <td><div align="left">：选择本地 S7-1200 作为主动连接；</div></td>
    </tr>
    <tr>
      <td>地址详细信息</td>
      <td><div align="left">：定义通信伙伴方的端口号为：2000。　　</div></td>
    </tr>
  </tbody>
</table>
<p><strong>注意：</strong>伙伴端口号是因为服务器（S7-300）设置为2000，所以这里设置为2000。</p>
<h4><strong>2．定义 S7-1200 的&ldquo;TSEND&rdquo;发送通信块接口参数</strong></h4>
<p>①　调用 &ldquo;TSEND&rdquo; 在OB1内调用  发送10个字节数据到 S7-300PN 中 <br />
  进入 &ldquo;项目树&rdquo; &gt; &ldquo; PLC_1&rdquo; &gt; &ldquo;程序块&rdquo; &gt; &ldquo;OB1&rdquo; 主程序中，从右侧窗口 &ldquo;指令&rdquo; &gt; &ldquo;通信&rdquo; &gt; &ldquo;开放式用户通信&rdquo;下调用 &ldquo;TSEND&rdquo; 指令，如图42所示。</p>
<p><img src="images/1-10.jpg" width="728" height="559" /></p>
<p>图42. 调用 TSEND </p>
<p>②　创建并定义S7-1200的发送数据区 DB 块。<br />
  <br />
  通过&ldquo;项目树&rdquo;&gt;&ldquo;PLC_1&rdquo;&gt;&ldquo;程序块&rdquo;&gt;&ldquo;添加新块&rdquo;，选择&ldquo;数据块&rdquo; 创建 DB 块，在DB块的&ldquo;属性-&gt;常规-&gt;属性&rdquo;中，取消勾选&ldquo;优化的块访问&rdquo;，点击&ldquo;确定&rdquo;键，定义发送数据区为 10个字节的数组，如图43及图44所示。
  </h4>
</p>
<p><img src="images/1-11.jpg" width="1131" height="599" /><br />
  <br />
  图43. 创建发送数据区 DB 块<br />
  <br />
  注意：对于双边编程通信的 CPU ，如果通信数据区使用 DB 块，既可以将 DB 块定义成符号寻址，也可以定义成绝对寻址。使用指针寻址方式，必须创建绝对寻址的 DB 块。</p>
<p><img src="images/1-12.JPG" width="520" height="79" /></p>
<p>图44. 定义发送数据区为字节类型的数组 </p>
<p>③　定义S7-1200 的&ldquo;TSEND&rdquo;发送通信块接口参数，如图45所示。</p>
<p><img src="images/1-13.jpg" width="559" height="292" /><br />
  <br />
  图45. 定义 TSEND 接口参数<br />
  <br />
  <strong>参数说明：</strong><br />
  <strong>输入接口参数：</strong></p>
<table width="463" border="0
">
  <tr>
    <td width="65"><div align="left">REQ　　</div></td>
    <td width="388"><div align="left">：在上升沿启动发送作业</div></td>
  </tr>
  <tr>
    <td><div align="left">ID　</div></td>
    <td><div align="left">：引用由&ldquo;TCON&rdquo;建立的连接</div></td>
  </tr>
  <tr>
    <td><div align="left">LEN</div></td>
    <td><div align="left">：要通过作业发送的最大字节数</div></td>
  </tr>
  <tr>
    <td><div align="left">DATA　</div></td>
    <td><div align="left">：发送数据区的数据，使用指针寻址时，DB块要选用绝对寻址</div></td>
  </tr>
</table>
<p><strong>输出接口参数：</strong></p>
<table width="459" border="0">
  <tr>
    <td width="91"><div align="left">DONE</div></td>
    <td width="358" ><div align="left">：任务执行完成并且没有错误，该位置 1</div></td>
  </tr>
  <tr>
    <td><div align="left">BUSY　</div></td>
    <td><div align="left">：该位为 1，代表任务未完成，不能激活新任务</div></td>
  </tr>
  <tr>
    <td><div align="left">ERROR　　　</div></td>
    <td><div align="left">：通信过程中有错误发生，该位置 1</div></td>
  </tr>
  <tr>
    <td><div align="left">STATUS</div></td>
    <td><div align="left">：有错误发生时，会显示错位信息号</div></td>
  </tr>
</table>
<h4><strong>3．在  S7-1200 的OB1中调用接收指令TRCV 并配置基本参数</strong></h4>
<p>为了实现 S7-1200 接收来自 S7-300PN 的数据，则在 S7-1200 中调用接收指令TRCV 并配置基本参数。 </p>
<p>①　创建并定义S7-1200的接收数据区 DB 块。<br />
  <br />
  通过&ldquo;项目树&rdquo;&gt;&ldquo;PLC_1&rdquo;&gt;&ldquo;程序块&rdquo;&gt;&ldquo;添加新块&rdquo;，选择&ldquo;数据块&rdquo; 创建 DB 块，在DB块的&ldquo;属性-&gt;常规-&gt;属性&rdquo;中，取消勾选&ldquo;优化的块访问&rdquo;，点击&ldquo;确定&rdquo;键，定义接收数据区为 10个字节的数组，如图46及图47所示。 </p>
<p><img src="images/1-14.jpg" width="1131" height="599" /><br />
  <br />
  图46. 创建接收数据区 DB 块<br />
  <br />
  注意：对于双边编程通信的 CPU ，如果通信数据区使用 DB 块，既可以将 DB 块定义成符号寻址，也可以定义成绝对寻址。使用指针寻址方式，必须创建绝对寻址的 DB 块。</p>
<p><img src="images/1-15.JPG" width="518" height="79" /></p>
<p>图47. 定义接收数据区为字节类型的数组</p>
<p>②　调用 &ldquo;TRCV&rdquo; 在OB1内调用 <br />
  进入 &ldquo;项目树&rdquo; &gt; &ldquo; PLC_1&rdquo; &gt; &ldquo;程序块&rdquo; &gt; &ldquo;OB1&rdquo; 主程序中，从右侧窗口 &ldquo;指令&rdquo; &gt; &ldquo;通信&rdquo; &gt; &ldquo;开放式用户通信&rdquo;下调用 &ldquo;TRCV&rdquo; 指令，配置接口参数，如图48所示。<br />
  <br />
  <img src="images/1-16.JPG" width="563" height="330" /><br />
  图48. 调用 TRCV 指令并配置接口参数</p>
<p><strong>参数说明：</strong><br />
  <strong>输入接口参数：</strong></p>
<table width="498" border="0">
  <tr>
    <td width="100"><div align="left">EN_R </div></td>
    <td width="388"><div align="left">：启用接收功能</div></td>
  </tr>
  <tr>
    <td><div align="left">ID</div></td>
    <td><div align="left">：指向使用&ldquo;TCON&rdquo;建立的连接的引用</div></td>
  </tr>
  <tr>
    <td><div align="left">LEN</div></td>
    <td><div align="left">：接收数据长度</div></td>
  </tr>
  <tr>
    <td><div align="left">ADHOC</div></td>
    <td><div align="left">：TCP协议选项是否使用Ad-hoc模式</div></td>
  </tr>
  <tr>
    <td><div align="left">DATA </div></td>
    <td><div align="left">：接收数据区的地址</div></td>
  </tr>
</table>
<p><strong>输出接口参数：</strong></p>
<table width="460" border="0">
  <tr>
    <td width="99"><div align="left">NDR </div></td>
    <td width="351"><div align="left">：该位为 1，接收任务成功完成</div></td>
  </tr>
  <tr>
    <td><div align="left">BUSY</div></td>
    <td><div align="left">：该位为 1，代表任务未完成，不能激活新任务</div></td>
  </tr>
  <tr>
    <td><div align="left">ERROR </div></td>
    <td><div align="left">：通信过程中有错误发生，该位置 1</div></td>
  </tr>
  <tr>
    <td><div align="left">STATUS</div></td>
    <td><div align="left"> ：有错误发生时，会显示错误信息号</div></td>
  </tr>
  <tr>
    <td><div align="left">RCVD_LEN　　</div></td>
    <td><div align="left">：实际接收数据的字节数</div></td>
  </tr>
</table>
<p><strong>注意：ADHOC设置为 TRUE 可以接收变长数据。 </strong><br />
</p>
<h3>2.5 下载硬件组态及程序并监控通信结果</h3>
<p>下载两个 CPU 中的所有硬件组态及程序，实现两个 CPU 之间数据交换，监控结果如图49所示。</p>
<p><img src="images/1-25.jpg" width="805" height="496" /></p>
<p>图49. 监控结果</p>
<h3><a name="c" id="c"></a>三. 第三种情况（S7-1200在TIA项目中，S7-300在STEP7项目中）</h3>
<p>使用STEP7 V5.6在一个项目中，新建一个S7-300站点，使用 STEP 7 V16 在一个项目中，新建一个S7-1200站点，然后做 TCP 通讯。 </p>
<h3>3.1 S7-300PN 侧通信的编程，连接参数及通信参数的配置</h3>
<h4><strong>1．创建PLC项目</strong></h4>
<p>在<span lang="de" xml:lang="de"> STEP7 V5.6</span>中创建一个项目并插入<span lang="de" xml:lang="de">CPU315-2PN/DP</span>站。操作步骤如下：</p>
<p>(1) 在<span lang="de" xml:lang="de"> PC </span>上打开 <span lang="de" xml:lang="de">STEP7 V5.6，</span>在<span lang="de" xml:lang="de"> &ldquo;File&rdquo; </span>菜单中选择<span lang="de" xml:lang="de"> &ldquo;New&hellip;&rdquo; </span>选项，如图50所示。</p>
<p><img src="images/1-28.jpg" width="560" height="484" /></p>
<p>图50. 新建项目</p>
<p>(2) 在弹出的创建新项目窗口里输入项目名为&ldquo;<span lang="de" xml:lang="de">TCP_Server</span>&rdquo;，然后点击&ldquo;<span lang="de" xml:lang="de">OK</span>&rdquo;按钮，如图51所示。</p>
<p><img src="images/1-29.jpg" width="509" height="537" /></p>
<p>图51. 输入项目名称</p>
<p>(3) 在<span lang="de" xml:lang="de">TCP_Server</span>下点击右键&ldquo;<span lang="de" xml:lang="de">Insert New Object</span>&rdquo;，选择&ldquo;<span lang="de" xml:lang="de">SIMATIC 300 Station</span>&rdquo;，如图52所示。</p>
<p><img src="images/1-30.jpg" width="714" height="620" /></p>
<p>图52. 插入300站点</p>
<p>(4) 双击&ldquo;<span lang="de" xml:lang="de">Hardware</span>&rdquo;打开硬件组态，如图53所示。</p>
<p><img src="images/1-31.jpg" width="750" height="174" /></p>
<p>图53. 硬件组态</p>
<p>(5) 插入<span lang="de" xml:lang="de"> S7-300 </span>插槽，如图54所示。</p>
<p><img src="images/1-32.jpg" width="1201" height="817" /></p>
<p>图54. 插入<span lang="de" xml:lang="de"> S7-300 </span>插槽</p>
<p>(6) 插入<span lang="de" xml:lang="de">S7-300 CPU</span>，与实际<span lang="de" xml:lang="de">PLC</span>一致：<span lang="de" xml:lang="de"> 6ES7 315-2EH14-0AB0 V3.2</span>，如图55所示。</p>
<p><img src="images/1-33.jpg" width="1202" height="817" /></p>
<p>图55. 插入<span lang="de" xml:lang="de"> S7-300 </span>CPU</p>
<p>(7) 在弹出的&ldquo;Properties-Ethernet  interface PN-IO&rdquo;对话框的&ldquo;Parmeters&rdquo;选项卡中为以太网接口添加，设置IP地址192.168.0.1和子网掩码255.255.255.0 ，如图56所示。</p>
<p><img src="images/1-34.jpg" width="1197" height="818" /></p>
<p>图56. 设置IP地址和子网掩码</p>
<p>(8)点击&ldquo;<span lang="de" xml:lang="de">New...</span>&rdquo;新建子网，如图57所示。</p>
<p><img src="images/1-35.jpg" width="654" height="527" /></p>
<p>图57. 新建子网</p>
<p>(9) &ldquo;<span lang="de" xml:lang="de">New subnet Industrial  Ethernet</span>&rdquo;对话框下<span lang="de" xml:lang="de"> Name</span>：<span lang="de" xml:lang="de">Ethernet(1)</span>，如图58所示。</p>
<p><img src="images/1-36.jpg" width="653" height="490" /></p>
<p>图58. 子网名称</p>
<p>(10) 新建<span lang="de" xml:lang="de"> Subnet </span>后，点击&ldquo;<span lang="de" xml:lang="de">OK</span>&rdquo;，如图59所示。</p>
<p><img src="images/1-37.jpg" width="653" height="527" /></p>
<p>图59. 确认子网</p>
<p>(11)点击&ldquo;<span lang="de" xml:lang="de">Save and Compile</span>&rdquo;按钮。编译保存硬件组态信息，如图60所示。</p>
<p><img src="images/1-38.jpg" width="1200" height="816" /></p>
<p>图60. 保存并编译硬件组态</p>
<h4><strong>2．TCP通信向导组态</strong></h4>
<p>创建用于开放式<span lang="de" xml:lang="de"> TCP/IP </span>通信的连接数据的向导<span lang="de" xml:lang="de"> (</span>开放式通信向导<span lang="de" xml:lang="de">)</span>下载链接：<span lang="de" xml:lang="de">https://support.industry.siemens.com/cs/cn/en/view/98957840/zh</span></p>
<p>(1) 开始菜单中选择&ldquo;<span lang="de" xml:lang="de">SIMATIC</span>&rdquo;&mdash;&ldquo;<span lang="de" xml:lang="de">Open Communication Wizard</span>&rdquo;，如图61所示。</p>
<p><img src="images/1-39.jpg" width="507" height="449" /></p>
<p>图61. 选择TCP通信向导</p>
<p>(2) 打开&ldquo;<span lang="de" xml:lang="de">Open  Communication Wizard</span>&rdquo;，如图62所示。</p>
<p><img src="images/1-40.jpg" width="646" height="483" /></p>
<p>图62. 打开TCP通信向导</p>
<p>(3) 选择<span lang="de" xml:lang="de"> STEP 7  project</span>，如图63所示。</p>
<p><img src="images/1-41.jpg" width="642" height="484" /></p>
<p>图63. 选择<span lang="de" xml:lang="de"> STEP 7  project</span></p>
<p>(4) 选择<span lang="de" xml:lang="de"> TCP_Server </span>项目，如图64所示。</p>
<p><img src="images/1-42.jpg" width="622" height="442" /></p>
<p>图64. 选择项目</p>
<p>(5) 选择<span lang="de" xml:lang="de"> Block  folder，如图65所示</span>。</p>
<p><img src="images/1-43.jpg" width="647" height="484" /></p>
<p>图65. 选择 Block  folder</p>
<p>(6) 选择项目下的<span lang="de" xml:lang="de">Blocks</span>，如图66所示。</p>
<p><img src="images/1-44.jpg" width="644" height="481" /></p>
<p>图66. 选择 Blocks</p>
<p>(7) 点击&ldquo;<span lang="de" xml:lang="de">Next</span>&rdquo;，如图67所示。</p>
<p><img src="images/1-45.jpg" width="647" height="483" /></p>
<p>图67. 点击下一步</p>
<p>(8) 点击&ldquo;<span lang="de" xml:lang="de">OK</span>&rdquo;，如图68所示。</p>
<p><img src="images/1-46.jpg" width="563" height="443" /></p>
<p>图68. 点击确认</p>
<p>(9) 点击&ldquo;<span lang="de" xml:lang="de">Next</span>&rdquo;，如图69所示。</p>
<p><img src="images/1-47.jpg" width="649" height="483" /></p>
<p>图69. 点击下一步</p>
<p>(10) 选择&ldquo;<span lang="de" xml:lang="de">Connection  type</span>&rdquo;&mdash;&ldquo;<span lang="de" xml:lang="de">TCP native</span>&rdquo;<span lang="de" xml:lang="de">, </span>点击&ldquo;<span lang="de" xml:lang="de">Next</span>&rdquo;，如图70所示。</p>
<p><img src="images/1-48.jpg" width="645" height="482" /></p>
<p>图70. 选择TCP通信</p>
<p><span lang="de" xml:lang="de">(11) Connect name:</span>&ldquo;<span lang="de" xml:lang="de">300_Server</span>&rdquo;。因为<span lang="de" xml:lang="de"> S7 300 </span>作服务器，因此选择&ldquo;<span lang="de" xml:lang="de">Passive</span>&rdquo;，如图71所示。</p>
<p><img src="images/1-49.jpg" width="645" height="480" /></p>
<p>图71. 配置本地连接</p>
<p>(12) 选择<span lang="de" xml:lang="de">User  interface</span>：<span lang="de" xml:lang="de">CPU 314/315/317/ET200pro</span>（<span lang="de" xml:lang="de">IM154-8  CPU</span>），如图72所示。</p>
<p><img src="images/1-50.jpg" width="641" height="480" /></p>
<p>图72. 选择接口</p>
<p><span lang="de" xml:lang="de">(13) Communication  parter A </span>端口号：<span lang="de" xml:lang="de">2000</span>，点击&ldquo;<span lang="de" xml:lang="de">Next</span>&rdquo;，如图73所示。</p>
<p><img src="images/1-51.jpg" width="646" height="486" /></p>
<p>图73. 配置端口</p>
<p><span lang="de" xml:lang="de">(14) Communication  parter A</span>，数据块<span lang="de" xml:lang="de">Name</span>：<span lang="de" xml:lang="de">DB1</span>0，点击&ldquo;<span lang="de" xml:lang="de">Next</span>&rdquo;，如图74所示。</p>
<p><img src="images/1-52.jpg" width="645" height="484" /></p>
<p>图74. 配置数据块</p>
<p>(15) 点击&ldquo;<span lang="de" xml:lang="de">Next</span>&rdquo;，如图75所示。</p>
<p><img src="images/1-53.jpg" width="645" height="486" /></p>
<p>图75. 点击下一步</p>
<p>(16) 点击&ldquo;<span lang="de" xml:lang="de">Finish</span>&rdquo;，如图76所示。</p>
<p><img src="images/1-54.jpg" width="643" height="486" /></p>
<p>图76. 点击完成</p>
<p>(17) 点击&ldquo;是&rdquo;，如图77所示。</p>
<p><img src="images/1-55.jpg" width="645" height="483" /></p>
<p>图77. 点击确认</p>
<h4><strong>3．TCP通信编程</strong></h4>
<p>(1) 查看<span lang="de" xml:lang="de"> SIMATIC  Manager</span>&mdash;<span lang="de" xml:lang="de">Blocks </span>下生成了<span lang="de" xml:lang="de"> DB1</span>0，如图78所示。</p>
<p><img src="images/1-56.jpg" width="1016" height="233" /></p>
<p>图78. 查看Blocks</p>
<p>(2) 双击<span lang="de" xml:lang="de"> OB1</span>进入，如图79所示。</p>
<p><img src="images/1-57.jpg" width="640" height="497" /></p>
<p>图79. 点击OB1</p>
<p>(3) 需要的功能块，如图80所示。</p>
<p><img src="images/1-58.JPG" width="804" height="822" /></p>
<p>图80. 查找功能块</p>
<p>(4) 插入<span lang="de" xml:lang="de"> FB65  TCON，如图81所示</span></p>
<p><img src="images/1-59.jpg" width="937" height="1032" /></p>
<p>图81. 插入FB65</p>
<p>(5) 添加背景<span lang="de" xml:lang="de">DB，如图82所示</span>。</p>
<p><img src="images/1-60.jpg" width="939" height="1027" /></p>
<p>图82. 添加背景DB</p>
<p>(6) 打开<span lang="de" xml:lang="de">DB1</span>0，复制&ldquo;<span lang="de" xml:lang="de">OUCW_1</span>&rdquo;名称，如图83所示。</p>
<p><img src="images/1-61.jpg" width="938" height="1030" /></p>
<p>图83. 复制变量名称</p>
<p>(7) &ldquo;<span lang="de" xml:lang="de">CONNECT</span>&rdquo;引脚输入<span lang="de" xml:lang="de">DB10，</span>粘贴&ldquo;<span lang="de" xml:lang="de">OUCW_1</span>&rdquo;，如图84所示。</p>
<p><img src="images/1-62.jpg" width="937" height="1029" /></p>
<p>图84. 连接参数</p>
<p>(8) 正确填写<span lang="de" xml:lang="de"> FB65 </span>引脚，如图85所示。</p>
<p><img src="images/1-63.jpg" width="471" height="343" /></p>
<p>图85. 调用FB65</p>
<p>(9) 添加<span lang="de" xml:lang="de"> Bata  Block</span>，如图86所示。</p>
<p><img src="images/1-64.jpg" width="1011" height="718" /></p>
<p>图86. 添加数据块</p>
<p>(10) 添加共享<span lang="de" xml:lang="de"> DB1</span>，作为发送数据区，如图87所示。</p>
<p><img src="images/1-65.jpg" width="641" height="496" /></p>
<p>图87. 定义发送数据块</p>
<p>(11) 添加变量，类型为数组，如图88所示。</p>
<p><img src="images/1-66.jpg" width="728" height="350" /></p>
<p>图88. 修改数据类型</p>
<p>(12) 添加<span lang="de" xml:lang="de">10</span>个<span lang="de" xml:lang="de"> BYTE </span>的数组变量，如图89所示。</p>
<p><img src="images/1-67.jpg" width="449" height="132" /></p>
<p>图89. 定义变量</p>
<p>(13)在S7-300项目的Hardware中，右键点击CPU，选择Object Properties-&gt;Cycle/Clock Memory，勾选&ldquo;Clock memory&rdquo;，输入Memory byte，如图90所示。</p>
<p><img src="images/1-68.JPG" width="535" height="448" /></p>
<p>图90 使用时钟存储器</p>
<p>(14) 添加<span lang="de" xml:lang="de"> FB63</span>，背景数据块为<span lang="de" xml:lang="de">DB63</span>，正确填写<span lang="de" xml:lang="de"> FB63 </span>引脚，其中REQ使用时钟存储器M30.3，以2Hz的速率在0和1之间切换的一个位，如图91所示。</p>
<p><img src="images/1-69.JPG" width="404" height="325" /></p>
<p>图91. 调用FB63</p>
<p>(15) 添加共享<span lang="de" xml:lang="de"> DB2</span>，作为接收数据区，如图92所示。</p>
<p><img src="images/1-70.jpg" width="638" height="498" /></p>
<p>图92. 定义接收数据块</p>
<p>(16) 添加变量，类型为数组。添加<span lang="de" xml:lang="de">10</span>个<span lang="de" xml:lang="de"> BYTE </span>的数组变量，如图93所示。</p>
<p><img src="images/1-71.jpg" width="496" height="130" /></p>
<p>图93. 定义变量</p>
<p>(17) 添加<span lang="de" xml:lang="de"> FB64</span>，背景数据块为<span lang="de" xml:lang="de">DB64</span>，正确填写<span lang="de" xml:lang="de"> FB64 </span>引脚，如图94所示。</p>
<p><img src="images/1-72.jpg" width="451" height="353" /></p>
<p>图94. 调用FB64</p>
<h3>3.2 S7-1200 侧通信的编程，连接参数及通信参数的配置</h3>
<p><strong>1.	使用 STEP7 V16 软件新建一个项目并完成硬件配置</strong></p>
<p>在 STEP7 V16的 &ldquo;Portal 视图&rdquo; 中选择 &ldquo;创建新项目&rdquo; 创建一个新项目。</p>
<p><strong>2.</strong><strong>添加硬件并命名PLC</strong><br />
  <br />
  然后进入 &ldquo;项目视图&rdquo;，在&ldquo;项目树&rdquo; 下双击 &ldquo;添加新设备&rdquo;，在对话框中选择所使用的 S7-1200   CPU 添加到机架上，命名为 PLC_1，如图95所示。<br />
  <br />
  <img src="images/1-01.JPG" width="707" height="695" /></p>
<p>图95. 添加新设备 </p>
<p>为了编程方便，使用 CPU 属性中定义的时钟位，定义方法如下：<br />
  在 &ldquo;项目树&rdquo; &gt; &ldquo;S7-1200&rdquo; &gt; &ldquo;设备组态&rdquo; 中，选中 CPU ，然后在下面的属性窗口中，&ldquo;属性&rdquo; &gt; &ldquo;系统和时钟存储器&rdquo;   下，将时钟位定义在 MB0，如图96所示。<br />
  时钟位我们主要使用 M0.3，它是以 2Hz   的速率在 0 和 1 之间切换的一个位，可以使用它去自动激活发送任务。 </p>
<p><img src="images/1-02.JPG" width="605" height="545" /></p>
<p>图96. 时钟位</p>
<p><strong>3. 为 PROFINET 通信口分配以太网地址</strong></p>
<p>在 &ldquo;设备视图&rdquo;中点击 CPU 上代表PROFINET 通信口的绿色小方块，在下方会出现PROFINET 接口的属性，在 &ldquo;以太网地址&rdquo; 下分配IP 地址为 192.168.0.2 ，子网掩码为255.255.255.0，如图97所示。</p>
<p><img src="images/1-03.jpg" width="758" height="390" /></p>
<p>图97. 分配IP 地址</p>
<h3>3.3在 S7-1200 中调用并配置&ldquo;TCON&rdquo;、&ldquo;TSEND&rdquo;、&ldquo;TRCV&rdquo; 通信指令</h3>
<h4><strong>1．在 S7-1200 的 OB1 中调用&ldquo;TCON&rdquo; 通信指令 </strong></h4>
<p>① 在S7-1200 CPU 中调用发送通信指令，进入 &ldquo;项目树&rdquo; &gt; &ldquo; PLC_1&rdquo; &gt; &ldquo;程序块&rdquo; &gt; &ldquo;OB1&rdquo; 主程序中，从右侧窗口 &ldquo;指令&rdquo; &gt; &ldquo;通信&rdquo; &gt; &ldquo;开放式用户通信&rdquo;下调用 &ldquo;TCON&rdquo; 指令，创建连接，如图98所示。<br />
  <img src="images/1-08.jpg" width="564" height="293" /><br />
  图98. 调用&ldquo;TCON&rdquo;通信指令
  </h4>
</p>
<p><strong>注意：</strong>
  </h4>
S7-1200必须等S7-300先准备好（触发S7-300的TCON）后，才可以触发TCON。 </p>
<p> ② 定义 S7-1200 的 &ldquo;TCON&rdquo;连接参数</p>
<p>S7-1200 的 &ldquo;TCON&rdquo;指令的连接参数需要在指令下方的属性窗口&ldquo;属性&rdquo;&gt; &ldquo;组态&rdquo;&gt;&ldquo;连接参数&rdquo;中设置，如图99所示。<br />
  <img src="images/1-27.jpg" width="967" height="556" /></p>
<p>图99. 定义 TCON 连接参数 <br />
  <br />
  <strong>连接参数说明：</strong></p>
<table border="0" width="684">
  <tbody>
    <tr>
      <td width="117">端点</td>
      <td width="595"><div align="left">：可以通过点击选择按钮选择伙伴CPU为&ldquo;未指定&rdquo; ； </div></td>
    </tr>
    <tr>
      <td>连接类型</td>
      <td><div align="left">：选择通信协议为 TCP；</div></td>
    </tr>
    <tr>
      <td>连接 ID　</td>
      <td><div align="left">：连接的地址 ID 号，这个 ID 号在后面的编程里会用到；</div></td>
    </tr>
    <tr>
      <td>连接数据</td>
      <td><div align="left">：点击新建自动生成该数据块，如PLC_1_Connection_DB；</div></td>
    </tr>
    <tr>
      <td>主动建立连接</td>
      <td><div align="left">：选择本地 S7-1200 作为主动连接；</div></td>
    </tr>
    <tr>
      <td>地址详细信息</td>
      <td><div align="left">：定义通信伙伴方的端口号为：2000。　　</div></td>
    </tr>
  </tbody>
</table>
<p><strong>注意：</strong>伙伴端口号是因为服务器（S7-300）设置为2000，所以这里设置为2000。</p>
<h4><strong>2．定义 S7-1200 的&ldquo;TSEND&rdquo;发送通信块接口参数</strong></h4>
<p>①　调用 &ldquo;TSEND&rdquo; 在OB1内调用  发送10个字节数据到 S7-300PN 中 <br />
  进入 &ldquo;项目树&rdquo; &gt; &ldquo; PLC_1&rdquo; &gt; &ldquo;程序块&rdquo; &gt; &ldquo;OB1&rdquo; 主程序中，从右侧窗口 &ldquo;指令&rdquo; &gt; &ldquo;通信&rdquo; &gt; &ldquo;开放式用户通信&rdquo;下调用 &ldquo;TSEND&rdquo; 指令，如图100所示。</p>
<p><img src="images/1-10.jpg" width="728" height="559" /></p>
<p>图100. 调用 TSEND </p>
<p>②　创建并定义S7-1200的发送数据区 DB 块。<br />
  <br />
  通过&ldquo;项目树&rdquo;&gt;&ldquo;PLC_1&rdquo;&gt;&ldquo;程序块&rdquo;&gt;&ldquo;添加新块&rdquo;，选择&ldquo;数据块&rdquo; 创建 DB 块，在DB块的&ldquo;属性-&gt;常规-&gt;属性&rdquo;中，取消勾选&ldquo;优化的块访问&rdquo;，点击&ldquo;确定&rdquo;键，定义发送数据区为 10个字节的数组，如图101及图102所示。
  </h4>
</p>
<p><img src="images/1-11.jpg" width="1131" height="599" /><br />
  <br />
  图101. 创建发送数据区 DB 块<br />
  <br />
  注意：对于双边编程通信的 CPU ，如果通信数据区使用 DB 块，既可以将 DB 块定义成符号寻址，也可以定义成绝对寻址。使用指针寻址方式，必须创建绝对寻址的 DB 块。</p>
<p><img src="images/1-12.JPG" width="520" height="79" /></p>
<p>图102. 定义发送数据区为字节类型的数组 </p>
<p>③　定义S7-1200 的&ldquo;TSEND&rdquo;发送通信块接口参数，如图103所示。</p>
<p><img src="images/1-13.jpg" width="559" height="292" /><br />
  <br />
  图103. 定义 TSEND 接口参数<br />
  <br />
  <strong>参数说明：</strong><br />
  <strong>输入接口参数：</strong></p>
<table width="463" border="0
">
  <tr>
    <td width="64"><div align="left">REQ　　</div></td>
    <td width="389"><div align="left">：在上升沿启动发送作业</div></td>
  </tr>
  <tr>
    <td><div align="left">ID　</div></td>
    <td><div align="left">：引用由&ldquo;TCON&rdquo;建立的连接</div></td>
  </tr>
  <tr>
    <td><div align="left">LEN</div></td>
    <td><div align="left">：要通过作业发送的最大字节数</div></td>
  </tr>
  <tr>
    <td><div align="left">DATA　</div></td>
    <td><div align="left">：发送数据区的数据，使用指针寻址时，DB块要选用绝对寻址</div></td>
  </tr>
</table>
<p><strong>输出接口参数：</strong></p>
<table width="411" border="0">
  <tr>
    <td width="91"><div align="left">DONE</div></td>
    <td width="310" ><div align="left">：任务执行完成并且没有错误，该位置 1</div></td>
  </tr>
  <tr>
    <td><div align="left">BUSY　</div></td>
    <td><div align="left">：该位为 1，代表任务未完成，不能激活新任务</div></td>
  </tr>
  <tr>
    <td><div align="left">ERROR　　　</div></td>
    <td><div align="left">：通信过程中有错误发生，该位置 1</div></td>
  </tr>
  <tr>
    <td><div align="left">STATUS</div></td>
    <td><div align="left">：有错误发生时，会显示错位信息号</div></td>
  </tr>
</table>
<h4><strong>3．在  S7-1200 的OB1中调用接收指令TRCV 并配置基本参数</strong></h4>
<p>为了实现 S7-1200 接收来自 S7-300PN 的数据，则在 S7-1200 中调用接收指令TRCV 并配置基本参数。 </p>
<p>①　创建并定义S7-1200的接收数据区 DB 块。<br />
  <br />
  通过&ldquo;项目树&rdquo;&gt;&ldquo;PLC_1&rdquo;&gt;&ldquo;程序块&rdquo;&gt;&ldquo;添加新块&rdquo;，选择&ldquo;数据块&rdquo; 创建 DB 块，在DB块的&ldquo;属性-&gt;常规-&gt;属性&rdquo;中，取消勾选&ldquo;优化的块访问&rdquo;，点击&ldquo;确定&rdquo;键，定义接收数据区为 10个字节的数组，如图104及图105所示。 </p>
<p><img src="images/1-14.jpg" width="1131" height="599" /><br />
  <br />
  图104. 创建接收数据区 DB 块<br />
  <br />
  注意：对于双边编程通信的 CPU ，如果通信数据区使用 DB 块，既可以将 DB 块定义成符号寻址，也可以定义成绝对寻址。使用指针寻址方式，必须创建绝对寻址的 DB 块。</p>
<p><img src="images/1-15.JPG" width="518" height="79" /></p>
<p>图105. 定义接收数据区为字节类型的数组</p>
<p>②　调用 &ldquo;TRCV&rdquo; 在OB1内调用 <br />
  进入 &ldquo;项目树&rdquo; &gt; &ldquo; PLC_1&rdquo; &gt; &ldquo;程序块&rdquo; &gt; &ldquo;OB1&rdquo; 主程序中，从右侧窗口 &ldquo;指令&rdquo; &gt; &ldquo;通信&rdquo; &gt; &ldquo;开放式用户通信&rdquo;下调用 &ldquo;TRCV&rdquo; 指令，配置接口参数，如图106所示。<br />
  <br />
  <img src="images/1-16.JPG" width="563" height="330" /><br />
  图106. 调用 TRCV 指令并配置接口参数</p>
<p><strong>参数说明：</strong><br />
  <strong>输入接口参数：</strong></p>
<table width="498" border="0">
  <tr>
    <td width="100"><div align="left">EN_R </div></td>
    <td width="388"><div align="left">：启用接收功能</div></td>
  </tr>
  <tr>
    <td><div align="left">ID</div></td>
    <td><div align="left">：指向使用&ldquo;TCON&rdquo;建立的连接的引用</div></td>
  </tr>
  <tr>
    <td><div align="left">LEN</div></td>
    <td><div align="left">：接收数据长度</div></td>
  </tr>
  <tr>
    <td><div align="left">ADHOC</div></td>
    <td><div align="left">：TCP协议选项是否使用Ad-hoc模式</div></td>
  </tr>
  <tr>
    <td><div align="left">DATA </div></td>
    <td><div align="left">：接收数据区的地址</div></td>
  </tr>
</table>
<p><strong>输出接口参数：</strong></p>
<table width="460" border="0">
  <tr>
    <td width="99"><div align="left">NDR </div></td>
    <td width="351"><div align="left">：该位为 1，接收任务成功完成</div></td>
  </tr>
  <tr>
    <td><div align="left">BUSY</div></td>
    <td><div align="left">：该位为 1，代表任务未完成，不能激活新任务</div></td>
  </tr>
  <tr>
    <td><div align="left">ERROR </div></td>
    <td><div align="left">：通信过程中有错误发生，该位置 1</div></td>
  </tr>
  <tr>
    <td><div align="left">STATUS</div></td>
    <td><div align="left"> ：有错误发生时，会显示错误信息号</div></td>
  </tr>
  <tr>
    <td><div align="left">RCVD_LEN　　</div></td>
    <td><div align="left">：实际接收数据的字节数</div></td>
  </tr>
</table>
<p><strong>注意：ADHOC设置为 TRUE 可以接收变长数据。 </strong></p>
<h3>3.4 下载硬件组态及程序并监控通信结果</h3>
<h4><strong>1. TCP通信结果</strong></h4>
<p>(1) 写入<span lang="de" xml:lang="de">16</span>进制数据&ldquo;<span lang="de" xml:lang="de">11 13 15 17 19 12 14 16 18 20</span>&rdquo;，如图107所示。</p>
<p><img src="images/1-73.jpg" width="568" height="658" /></p>
<p>图107.<span lang="de" xml:lang="de">CPU315-2PN/DP 写入数据</span></p>
<p>(2) 触发&ldquo;<span lang="de" xml:lang="de">TSEND_REQ</span>&rdquo;，发送10个字节数据给S7-1200；触发&ldquo;<span lang="de" xml:lang="de">TRCV_EN_R</span>&rdquo;，接收到<span lang="de" xml:lang="de">S7-1200发送过来的 10 </span>个字节数据，如图108所示。</p>
<p><img src="images/1-74.jpg" width="892" height="656" /></p>
<p>图108.通信结果</p>
</body>
</html>
